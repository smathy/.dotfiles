#!/usr/bin/env zsh
vim=neovide
pipe=./.nvim.pipe
args=($@)

line_file() {
  local re=':[0-9]+$'
  local arg=$1
  if [[ $arg =~ $re ]]; then
    local pos=${arg[(I)[:]]}
    local line="+${arg:$pos}"
    arg="$line ${arg:0:$(($pos-1))}"
  fi
  echo $arg
}

send_alls() {
  for arg in $@; do
    nvim --server $pipe --remote-send "<ESC>:vs $(line_file $arg)<CR>" > /dev/null
  done
}

ensure_nvim() {
  if [[ ! -S $pipe ]]; then
    local arg=$1
    arg=${arg:+$(line_file $arg)}
    $vim $arg -- --listen $pipe
    [ $arg ] && shift args
    sleep 0.1
  fi
}

if [[ "$#" -eq 0 ]]; then
  ensure_nvim
  if [[ -f Session.vim ]]; then
    nvim --server $pipe --remote-send "<ESC>:source Session.vim<CR>" > /dev/null
  fi
elif [[ "${args[1]}" == "-" ]]; then
  nvim '+set buftype=nofile' -
else
  ensure_nvim $args[1]
  send_alls $args
  osascript -e 'tell application "neovide" to activate'
fi

# vim: ft=zsh
